name: Build Selaura APK & Native Libraries

on:
  push:
    branches: [ main, master, dev ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Install CMake 3.28.3
      run: |
        pip install cmake==3.28.3
        echo "$HOME/.local/bin" >> $GITHUB_PATH
        cmake --version

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools-version: 34.0.0
        ndk-version: 26.1.10909125

    - name: Setup Gradle Wrapper
      run: |
        cd android
        mkdir -p gradle/wrapper
        cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.4-all.zip
        networkTimeout=10000
        validateDistributionUrl=true
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        curl -L -o gradle/wrapper/gradle-wrapper.jar https://raw.githubusercontent.com/gradle/gradle/v8.4.0/gradle/wrapper/gradle-wrapper.jar
        chmod +x gradlew

    - name: Verify Gradle
      run: |
        cd android
        ./gradlew --version

    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Cache NDK Build Outputs
      uses: actions/cache@v4
      with:
        path: |
          android/app/.cxx
          android/app/build/intermediates/cmake
        key: ${{ runner.os }}-ndk-${{ hashFiles('**/CMakeLists.txt', '**/*.cpp', '**/*.h') }}
        restore-keys: |
          ${{ runner.os }}-ndk-

    - name: Build Native Libraries (.so)
      run: |
        cd android
        ./gradlew :app:externalNativeBuildRelease --stacktrace --no-daemon

    - name: Build APK
      run: |
        cd android
        ./gradlew assembleRelease --stacktrace --no-daemon

    - name: Collect Artifacts
      run: |
        mkdir -p artifacts/apk artifacts/libs/arm64-v8a
        find android/app/build/outputs/apk -name "*.apk" -exec cp {} artifacts/apk/ \;
        find android/app/build/intermediates -name "*.so" -path "*/arm64-v8a/*" -exec cp {} artifacts/libs/arm64-v8a/ \;
        ls -lhR artifacts/

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: selaura-apk
        path: artifacts/apk/*.apk
        retention-days: 30

    - name: Upload Native Libraries (.so)
      uses: actions/upload-artifact@v4
      with:
        name: native-libs-arm64-v8a
        path: artifacts/libs/arm64-v8a/*.so
        retention-days: 30

  release:
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: selaura-apk
        path: release/

    - name: Download Native Libraries
      uses: actions/download-artifact@v4
      with:
        name: native-libs-arm64-v8a
        path: release/libs/

    - name: Create Tag
      id: tag
      run: |
        TAG="build-$(date +%Y%m%d-%H%M%S)"
        echo "tag_name=$TAG" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag_name }}
        name: "Selaura Build ${{ steps.tag.outputs.tag_name }}"
        body: |
          âœ… **Selaura Client Build**
          
          - Includes `.apk` and `.so` files  
          - Built for Android 9+ ARM64  
          - Works with cracked & official MCPE
          
          **Commit:** ${{ github.sha }}
        files: |
          release/*.apk
          release/libs/*.so
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
